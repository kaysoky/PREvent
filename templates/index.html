{% extends "rest_framework/base.html" %}
{% load url from future %}
{% load staticfiles %}
{% load rest_framework %}

{% block body %}
<body class="{% block bodyclass %}{% endblock %}">

    <div class="wrapper">

        {% block navbar %}
            <div class="navbar navbar-static-top {% block bootstrap_navbar_variant %}navbar-inverse{% endblock %}">
                <div class="container">
                    <span>
                        {% block branding %}
                            <a class='navbar-brand' rel="nofollow" href='/'>
                                PREvent
                            </a>
                        {% endblock %}
                    </span>
                    <ul class="nav navbar-nav pull-right">
                        {% block userlinks %}
                            {% if user.is_authenticated %}
                                {% optional_logout request user %}
                            {% else %}
                                <li><a href="register/">Register</a></li>
                                {% optional_login request %}
                            {% endif %}
                        {% endblock %}
                    </ul>
                </div>
            </div>
        {% endblock %}
        
<link rel="stylesheet" type="text/css" href="static/bootstrap.min.css" />
<link rel="stylesheet" type="text/css" href="static/keen-dashboards.css" />
<body class="application">
  <div class="container-fluid">
    <div class="row">

      <div class="col-sm-8">
        <div class="chart-wrapper">
          <div class="chart-title">
            Heat Map of Sensor Levels
          </div>
             <div class='chart-stage' id="map-canvas" style="height: 400px"></div>
                   <div>
                        <div id="panel">
                          <button onclick="toggleTempMap()">Temperature</button>
                          <button onclick="toggleHumiMap()">Humidity</button>
                          <button onclick="toggleVocsMap()">Volatile Organic</button>
                          <button onclick="togglePartMap()">Particle 2.5</button>
                        </div>
                    </div>
          <div class="chart-notes">
            This is a sample text region to describe this chart.
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="chart-wrapper">
        	<div class="chart-title">
            Average Values For Each Sensor
          </div>
			<canvas class="chart-stage" id="barChart" width="500" height="300"></canvas>
          <div class="chart-notes">
            Temperature, Humidity, PM, VOC
        </div>
      </div>

    </div>


    <div class="row">

      <div class="col-sm-6 col-md-4">
        <div class="chart-wrapper">
          <div class="chart-title">
            Sensor Levels Hourly
          </div>
        	<canvas class="chart-stage" id="hourChart" width="500" height="300"></canvas>
          <div class="chart-notes">
            X-axis Displays Hourly Intervals
          </div>
        </div>
      </div>

    </div>

      <div class="col-sm-6 col-md-4">
        <div class="chart-wrapper">
          <div class="chart-title">
            Humidity Levels
          </div>
        	<canvas class="chart-stage" id="humiChart" width="500" height="500"></canvas>
          <div class="chart-notes">
            Timeline
          </div>
        </div>
      </div>

      <div class="col-sm-6 col-md-4">
        <div class="chart-wrapper">
          <div class="chart-title">
            Temperature Levels
          </div>
          <canvas class='chart-stage' id="tempChart" width="500" height="500"></canvas>
          <div class="chart-notes">
            Timeline
          </div>
          </div>
        </div>
      </div>

	<div class="col-sm-6 col-md-4">
        <div class="chart-wrapper">
          <div class="chart-title">
            Particulate Matter 2.5 Levels
          </div>
			<canvas class="chart-stage" id="partChart" width="500" height="500"></canvas>
          </div>
          <div class="chart-notes">
            Detects Smoke, Exhaust, and most air pollution
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-md-4">
        <div class="chart-wrapper">
          <div class="chart-title">
            Volatile Organic Compound Levels
          </div>
			<canvas class="chart-stage" id="vocsChart" width="500" height="500"></canvas>
          </div>
          <div class="chart-notes">
            X-axis represents date and time
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-md-4">
        <div class="chart-wrapper">
          <div class="chart-title">
            Cell Title
          </div>
          <div class="chart-stage">
            <img data-src="holder.js/100%x120/white">
          </div>
          <div class="chart-notes">
            Notes about this chart
          </div>
        </div>
      </div>
    </div>

  </div>

</body>
</html>


    {% block script %}
		<script src="{% static 'meta.js' %}"></script>
		<script src="{% static 'keen.min.js' %}"></script>
        <script src="{% static 'rest_framework/js/jquery-1.8.1-min.js' %}"></script>
        <script src="{% static 'rest_framework/js/bootstrap.min.js' %}"></script>
        <script src="{% static 'rest_framework/js/prettify-min.js' %}"></script>
        <script src="{% static 'rest_framework/js/default.js' %}"></script>
        <script src="{% static 'Chart.min.js' %}"></script>
        </script>
        <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?libraries=visualization&sensor=true_or_false"></script>
        <script>

        //TODO: MOVING AVERAGE
        //TODO: SORT DATA
        //TODO: Interval Date
            // Fetch data from the server
            var temp = [];
            var humi = [];
            var part = [];
            var vocs = [];
            var testChart = [];
            var humiTestChart = [];
            var partTestChart = [];
            var vocsTestChart = [];
            var dateChart = [];
            var fakeLabels = [];
            var tempByHour = {};
            var humiByHour = {};
            var partByHour = {};
            var vocsByHour = {};
            function fetchData() {
            	$.get('/data/').done(function(data) {
	                for (var index in data) {
	                    var coord = new google.maps.LatLng(data[index].ycoord, data[index].xcoord);
	                    var date = new Date(data[index].timestamp);
	                    var hour = date.getHours();
	                    tempByHour[hour] = tempByHour[hour]||[];
	                    tempByHour[hour].push(data[index].temperature);
	                    humiByHour[hour] = humiByHour[hour]||[];
	                    humiByHour[hour].push(data[index].humidity);
	                    partByHour[hour] = partByHour[hour]||[];
	                    partByHour[hour].push(data[index].particulate);
	                    vocsByHour[hour] = vocsByHour[hour]||[];
	                    vocsByHour[hour].push(data[index].gas);
	                    dateChart.push(date);
	                    fakeLabels.push(intervalDate(date, index, 25));
	                    temp.push({ location: coord, weight: data[index].temperature });
	                    humi.push({ location: coord, weight: data[index].humidity });
	                    part.push({ location: coord, weight: data[index].particulate });
	                    vocs.push({ location: coord, weight: data[index].gas });
	                    testChart.push(data[index].temperature);
	                    humiTestChart.push(Math.floor(data[index].humidity));
	                    partTestChart.push(Math.floor(data[index].particulate));
	                    vocsTestChart.push(Math.floor(data[index].gas));
	                }
	                averages();
	                initialize();
	                var hourTicks = Object.keys(tempByHour);
	                tempHour = group(tempByHour);
	                humiHour = group(humiByHour);
	                partHour = group(partByHour);
	                vocsHour = group(vocsByHour);

	                data1 = makeGraphs(testChart, fakeLabels);
	                data2 = makeGraphs(humiTestChart, fakeLabels);
	                data3 = makeGraphs(partTestChart, fakeLabels);
	                data4 = makeGraphs(vocsTestChart, fakeLabels);
	                data5 = makeFourGraphs(tempHour, humiHour, partHour, vocsHour, hourTicks);
	                var tC = document.getElementById('tempChart').getContext("2d");
	                var hC = document.getElementById('humiChart').getContext("2d");
	                var pC = document.getElementById('partChart').getContext("2d");
	                var vC = document.getElementById('vocsChart').getContext("2d");
	                var tHH = document.getElementById('hourChart').getContext("2d");
	                var tempChartz = new Chart(tC).Line(data1)
	                var humiChartz = new Chart(hC).Line(data2, {showXLabels: 10});
	                var partChartz = new Chart(pC).Line(data3)
	                var vocsChartz = new Chart(vC).Line(data4)
					var hourChartz = new Chart(tHH).Line(data5);	
	            });
	        }

	        function intervalDate(date, index, num) {
	        	if (index % num == 0) {
	        		return date
	        	} else {
	        		return ''
	        	}
	        }

			function averages()	{
				var tempMean = 0;
	        	var humiMean = 0;
	        	var partMean = 0;
	        	var vocsMean = 0;
				for(var i = 0; i < temp.length; i++) {
					tempMean = tempMean + temp[i]['weight']
					humiMean = humiMean + humi[i]['weight']
					partMean = partMean + part[i]['weight']
					vocsMean = vocsMean + vocs[i]['weight']
				}
				tempMean = tempMean/temp.length
				humiMean = humiMean/temp.length
				partMean = partMean/temp.length
				vocsMean = vocsMean/temp.length
				var data = {
				    labels: ["Temperature", "Humidity", "Particulate Matter", "Volatile Organic Compound"],
				    datasets: [
				        {
				            label: "Graphs",
				            fillColor: "rgba(220,220,220,0.5)",
				            strokeColor: "rgba(220,220,220,0.8)",
				            highlightFill: "rgba(220,220,220,0.75)",
				            highlightStroke: "rgba(220,220,220,1)",
				            data: [tempMean, humiMean, partMean, vocsMean]
				        }
				    ]
				};
				var ctx = document.getElementById("barChart").getContext("2d");
				var myBarChart = new Chart(ctx).Bar(data);
			};	        

			function group(dict) {
				var values = [];
				for(var key in dict) {
					values.push(ave(dict[key]));
				}
				return values
			}

			function ave(array) {
				var sum = 0;
				for(var i = 0; i < array.length; i++) {
					sum = sum + array[i];
				}
				sum = sum/array.length;
				return sum
			}


            var map;
            var tempHeatmap;
            var humiHeatmap;
            var partHeatmap;
            var vocsHeatmap;
            function initialize() {
                var mapOptions = {
                    zoom: 9,
                    // TEMP: Center map over Seattle
                    center: new google.maps.LatLng(47.450580, -122.307496),
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                };
              
                // Initialize Google Maps layer
                map = new google.maps.Map(document.getElementById('map-canvas'),
                    mapOptions);

				tempHeatmap = new google.maps.visualization.HeatmapLayer({
                    data: new google.maps.MVCArray(temp)
                });
                humiHeatmap = new google.maps.visualization.HeatmapLayer({
                    data: new google.maps.MVCArray(humi)
                });
                partHeatmap = new google.maps.visualization.HeatmapLayer({
                    data: new google.maps.MVCArray(part)
                });
                vocsHeatmap = new google.maps.visualization.HeatmapLayer({
                    data: new google.maps.MVCArray(vocs)
                });
            }

            function toggleTempMap() {
	            tempHeatmap.setMap(map);
	            humiHeatmap.setMap(null);
	            partHeatmap.setMap(null);
	            vocsHeatmap.setMap(null);
            }
            function toggleHumiMap() {
	            tempHeatmap.setMap(null);
	            humiHeatmap.setMap(map);
	            partHeatmap.setMap(null);
	            vocsHeatmap.setMap(null);
            }
            function togglePartMap() {
	            tempHeatmap.setMap(null);
	            humiHeatmap.setMap(null);
	            partHeatmap.setMap(map);
	            vocsHeatmap.setMap(null);
            }
            function toggleVocsMap() {
	            tempHeatmap.setMap(null);
	            humiHeatmap.setMap(null);
	            partHeatmap.setMap(null);
	            vocsHeatmap.setMap(map);
            }

			google.maps.event.addDomListener(window, 'load', fetchData);

			function makeGraphs(data1, dateChart, name) {
				var data = {
					labels: dateChart,
				    datasets: [
				        {
				            label: name,
				            fillColor: "rgba(220,220,220,0.4)",
				            strokeColor: "rgba(220,100,120,50)",
				            pointColor: "rgba(90,80,220,40)",
				            pointStrokeColor: "#fff",
				            pointHighlightFill: "#fff",
				            pointHighlightStroke: "rgba(220,220,220,1)",
				            data: data1
				        }
				    ]
				}	
				return data		    
			};

			function makeFourGraphs(data1, data2, data3, data4, dateChart) {
				var data = {
	    			labels: dateChart,
				    datasets: [
				        {
				            label: "Temperature",
				            fillColor: "rgba(220,220,220,0.2)",
				            strokeColor: "rgba(220,220,220,1)",
				            pointColor: "rgba(220,220,220,1)",
				            pointStrokeColor: "#fff",
				            pointHighlightFill: "#fff",
				            pointHighlightStroke: "rgba(220,220,220,1)",
				            data: data1
				        },
				        {
				        	label: "",
				            fillColor: "rgba(151,187,205,0.2)",
				            strokeColor: "rgba(151,187,205,1)",
				            pointColor: "rgba(151,187,205,1)",
				            pointStrokeColor: "#fff",
				            pointHighlightFill: "#fff",
				            pointHighlightStroke: "rgba(151,187,205,1)",
				            data: data2
				        }, 
				        {
				        	label: "",
				            fillColor: "rgba(151,187,205,0.2)",
				            strokeColor: "rgba(208,0,0,1)",
				            pointColor: "rgba(151,187,205,1)",
				            pointStrokeColor: "#fff",
				            pointHighlightFill: "#fff",
				            pointHighlightStroke: "rgba(151,187,205,1)",
				            data: data3
				        },
				        {
				        	label: "",
				            fillColor: "rgba(151,187,205,0.2)",
				            strokeColor: "rgba(200,100,115,1)",
				            pointColor: "rgba(151,187,205,1)",
				            pointStrokeColor: "#fff",
				            pointHighlightFill: "#fff",
				            pointHighlightStroke: "rgba(178,190,220,1)",
				            data: data4
				        }

				    ]
				}	
				return data		    
			};


        </script>
    {% endblock %}
  </body>
</html>
{% endblock %}
